# 评论系统模块4.1技术文档

## 1. 模块概述

### 1.1 模块目标
实现博客系统的评论后端API，支持评论的创建、查询、回复、点赞和删除功能，提供完整的评论管理能力。

### 1.2 核心功能
- 评论列表查询（支持嵌套结构）
- 评论创建和发布
- 评论回复功能
- 评论点赞/取消点赞
- 评论删除（软删除）
- 评论权限控制
- 评论内容安全验证

### 1.3 技术要求
- 遵循现有API设计规范
- 支持嵌套评论结构
- 实现完整的权限控制
- 提供数据验证和安全防护
- 支持分页和排序

## 2. 数据库设计

### 2.1 评论表结构

现有的comments表结构已经支持嵌套评论：

```sql
CREATE TABLE comments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  content TEXT NOT NULL,
  user_id INTEGER NOT NULL,
  article_id INTEGER NOT NULL,
  parent_id INTEGER DEFAULT NULL,
  likes INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE,
  FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
);
```

### 2.2 表字段说明

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 评论唯一标识 | 主键，自增 |
| content | TEXT | 评论内容 | 非空，最大10000字符 |
| user_id | INTEGER | 评论用户ID | 非空，外键关联users表 |
| article_id | INTEGER | 文章ID | 非空，外键关联articles表 |
| parent_id | INTEGER | 父评论ID | 可空，外键关联comments表 |
| likes | INTEGER | 点赞数 | 默认0 |
| created_at | DATETIME | 创建时间 | 默认当前时间 |
| updated_at | DATETIME | 更新时间 | 默认当前时间 |

### 2.3 索引设计

```sql
-- 现有索引
CREATE INDEX idx_comments_user_id ON comments(user_id);
CREATE INDEX idx_comments_article_id ON comments(article_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);
CREATE INDEX idx_comments_created_at ON comments(created_at DESC);

-- 建议新增的复合索引
CREATE INDEX idx_comments_article_parent ON comments(article_id, parent_id);
CREATE INDEX idx_comments_article_created ON comments(article_id, created_at DESC);
```

### 2.4 评论点赞表设计

为了记录用户点赞状态，需要新增评论点赞关联表：

```sql
CREATE TABLE comment_likes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  comment_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, comment_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (comment_id) REFERENCES comments(id) ON DELETE CASCADE
);

-- 创建索引
CREATE INDEX idx_comment_likes_user_id ON comment_likes(user_id);
CREATE INDEX idx_comment_likes_comment_id ON comment_likes(comment_id);
```

## 3. API接口设计

### 3.1 接口概览

| 接口 | 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|------|
| 获取评论列表 | GET | /api/comments | 获取文章的评论列表 | 公开 |
| 创建评论 | POST | /api/comments | 创建新评论 | 登录用户 |
| 回复评论 | POST | /api/comments/:id/reply | 回复指定评论 | 登录用户 |
| 点赞评论 | POST | /api/comments/:id/like | 点赞/取消点赞评论 | 登录用户 |
| 删除评论 | DELETE | /api/comments/:id | 删除指定评论 | 评论作者/管理员 |
| 获取评论详情 | GET | /api/comments/:id | 获取单个评论详情 | 公开 |

### 3.2 获取评论列表

**接口地址**: `GET /api/comments`

**请求参数**:
```json
{
  "article_id": 1,
  "page": 1,
  "limit": 20,
  "sort": "created_at",
  "order": "desc"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| article_id | number | 是 | 文章ID |
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认20，最大100 |
| sort | string | 否 | 排序字段，默认created_at |
| order | string | 否 | 排序方向，asc/desc，默认desc |

**响应示例**:
```json
{
  "success": true,
  "message": "获取评论列表成功",
  "data": {
    "comments": [
      {
        "id": 1,
        "content": "这篇文章写得很好！",
        "user_id": 2,
        "article_id": 1,
        "parent_id": null,
        "likes": 5,
        "created_at": "2024-01-01T10:00:00.000Z",
        "updated_at": "2024-01-01T10:00:00.000Z",
        "user": {
          "id": 2,
          "username": "张三",
          "avatar": "http://example.com/avatar.jpg"
        },
        "replies": [
          {
            "id": 2,
            "content": "谢谢支持！",
            "user_id": 1,
            "article_id": 1,
            "parent_id": 1,
            "likes": 2,
            "created_at": "2024-01-01T11:00:00.000Z",
            "updated_at": "2024-01-01T11:00:00.000Z",
            "user": {
              "id": 1,
              "username": "作者",
              "avatar": "http://example.com/author.jpg"
            },
            "replies": []
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 50,
      "totalPages": 3
    }
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### 3.3 创建评论

**接口地址**: `POST /api/comments`

**请求头**:
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数**:
```json
{
  "content": "这是一条评论内容",
  "article_id": 1
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| content | string | 是 | 评论内容，1-10000字符 |
| article_id | number | 是 | 文章ID |

**响应示例**:
```json
{
  "success": true,
  "message": "评论发布成功",
  "data": {
    "comment": {
      "id": 3,
      "content": "这是一条评论内容",
      "user_id": 2,
      "article_id": 1,
      "parent_id": null,
      "likes": 0,
      "created_at": "2024-01-01T12:00:00.000Z",
      "updated_at": "2024-01-01T12:00:00.000Z",
      "user": {
        "id": 2,
        "username": "张三",
        "avatar": "http://example.com/avatar.jpg"
      }
    }
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### 3.4 回复评论

**接口地址**: `POST /api/comments/:id/reply`

**请求头**:
```
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数**:
```json
{
  "content": "这是一条回复内容"
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 父评论ID（URL参数） |
| content | string | 是 | 回复内容，1-10000字符 |

**响应示例**:
```json
{
  "success": true,
  "message": "回复发布成功",
  "data": {
    "comment": {
      "id": 4,
      "content": "这是一条回复内容",
      "user_id": 3,
      "article_id": 1,
      "parent_id": 1,
      "likes": 0,
      "created_at": "2024-01-01T13:00:00.000Z",
      "updated_at": "2024-01-01T13:00:00.000Z",
      "user": {
        "id": 3,
        "username": "李四",
        "avatar": "http://example.com/avatar2.jpg"
      }
    }
  },
  "timestamp": "2024-01-01T13:00:00.000Z"
}
```

### 3.5 点赞评论

**接口地址**: `POST /api/comments/:id/like`

**请求头**:
```
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "message": "点赞成功",
  "data": {
    "liked": true,
    "likes": 6
  },
  "timestamp": "2024-01-01T14:00:00.000Z"
}
```

### 3.6 删除评论

**接口地址**: `DELETE /api/comments/:id`

**请求头**:
```
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "message": "评论删除成功",
  "timestamp": "2024-01-01T15:00:00.000Z"
}
```

## 4. 权限控制

### 4.1 权限矩阵

| 操作 | 游客 | 登录用户 | 评论作者 | 文章作者 | 管理员 |
|------|------|----------|----------|----------|--------|
| 查看评论 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 发表评论 | ✗ | ✓ | ✓ | ✓ | ✓ |
| 回复评论 | ✗ | ✓ | ✓ | ✓ | ✓ |
| 点赞评论 | ✗ | ✓ | ✓ | ✓ | ✓ |
| 删除自己评论 | ✗ | ✗ | ✓ | ✗ | ✓ |
| 删除他人评论 | ✗ | ✗ | ✗ | ✓ | ✓ |

### 4.2 权限验证逻辑

```typescript
// 评论删除权限检查
function canDeleteComment(user: User, comment: Comment, article: Article): boolean {
  // 管理员可以删除任何评论
  if (user.role === 'admin') {
    return true;
  }
  
  // 文章作者可以删除文章下的任何评论
  if (article.author_id === user.id) {
    return true;
  }
  
  // 评论作者可以删除自己的评论
  if (comment.user_id === user.id) {
    return true;
  }
  
  return false;
}
```

## 5. 数据验证规则

### 5.1 评论内容验证

```typescript
interface CommentValidation {
  content: {
    required: true;
    minLength: 1;
    maxLength: 10000;
    pattern: /^[\s\S]*$/; // 允许所有字符包括换行
    sanitize: true; // HTML标签过滤
  };
  article_id: {
    required: true;
    type: 'number';
    exists: 'articles.id'; // 验证文章是否存在
  };
  parent_id?: {
    type: 'number';
    exists: 'comments.id'; // 验证父评论是否存在
    sameArticle: true; // 验证父评论是否属于同一文章
  };
}
```

### 5.2 内容安全过滤

```typescript
// 敏感词过滤
const sensitiveWords = ['敏感词1', '敏感词2'];

// HTML标签过滤
function sanitizeContent(content: string): string {
  // 移除HTML标签，保留纯文本
  return content.replace(/<[^>]*>/g, '');
}

// 内容长度限制
function validateContentLength(content: string): boolean {
  const trimmed = content.trim();
  return trimmed.length >= 1 && trimmed.length <= 10000;
}
```

## 6. 错误处理机制

### 6.1 评论相关错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| COMMENT_NOT_FOUND | 404 | 评论不存在 |
| COMMENT_CONTENT_EMPTY | 400 | 评论内容为空 |
| COMMENT_CONTENT_TOO_LONG | 400 | 评论内容过长 |
| COMMENT_ARTICLE_NOT_FOUND | 400 | 文章不存在 |
| COMMENT_PARENT_NOT_FOUND | 400 | 父评论不存在 |
| COMMENT_PARENT_MISMATCH | 400 | 父评论与文章不匹配 |
| COMMENT_DELETE_FORBIDDEN | 403 | 无权删除评论 |
| COMMENT_ALREADY_LIKED | 400 | 已经点赞过 |
| COMMENT_NOT_LIKED | 400 | 尚未点赞 |

### 6.2 错误响应示例

```json
{
  "success": false,
  "message": "评论内容不能为空",
  "error": {
    "code": "COMMENT_CONTENT_EMPTY",
    "details": "评论内容至少需要1个字符"
  },
  "timestamp": "2024-01-01T16:00:00.000Z"
}
```

## 7. 性能优化

### 7.1 查询优化

```sql
-- 优化的评论列表查询（分页 + 嵌套）
WITH RECURSIVE comment_tree AS (
  -- 获取顶级评论
  SELECT 
    c.*,
    u.username,
    u.avatar,
    0 as level
  FROM comments c
  JOIN users u ON c.user_id = u.id
  WHERE c.article_id = ? AND c.parent_id IS NULL
  ORDER BY c.created_at DESC
  LIMIT ? OFFSET ?
  
  UNION ALL
  
  -- 递归获取回复
  SELECT 
    c.*,
    u.username,
    u.avatar,
    ct.level + 1
  FROM comments c
  JOIN users u ON c.user_id = u.id
  JOIN comment_tree ct ON c.parent_id = ct.id
  WHERE ct.level < 3  -- 限制嵌套层级
)
SELECT * FROM comment_tree ORDER BY level, created_at;
```

### 7.2 缓存策略

```typescript
// Redis缓存键设计
const CACHE_KEYS = {
  COMMENT_LIST: (articleId: number, page: number) => `comments:article:${articleId}:page:${page}`,
  COMMENT_COUNT: (articleId: number) => `comments:count:${articleId}`,
  COMMENT_DETAIL: (commentId: number) => `comment:${commentId}`,
};

// 缓存过期时间
const CACHE_TTL = {
  COMMENT_LIST: 300, // 5分钟
  COMMENT_COUNT: 600, // 10分钟
  COMMENT_DETAIL: 1800, // 30分钟
};
```

## 8. 测试要点

### 8.1 单元测试

- 评论创建功能测试
- 评论查询功能测试
- 评论回复功能测试
- 评论点赞功能测试
- 评论删除功能测试
- 权限控制测试
- 数据验证测试

### 8.2 集成测试

- 评论嵌套结构测试
- 评论分页功能测试
- 评论排序功能测试
- 评论与文章关联测试
- 评论与用户关联测试

### 8.3 性能测试

- 大量评论查询性能
- 深层嵌套评论性能
- 并发评论创建测试
- 数据库查询优化验证

## 9. 部署注意事项

### 9.1 数据库迁移

```sql
-- 添加评论点赞表
CREATE TABLE comment_likes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  comment_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, comment_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (comment_id) REFERENCES comments(id) ON DELETE CASCADE
);

-- 添加索引
CREATE INDEX idx_comment_likes_user_id ON comment_likes(user_id);
CREATE INDEX idx_comment_likes_comment_id ON comment_likes(comment_id);
CREATE INDEX idx_comments_article_parent ON comments(article_id, parent_id);
CREATE INDEX idx_comments_article_created ON comments(article_id, created_at DESC);
```

### 9.2 环境配置

```env
# 评论相关配置
COMMENT_MAX_LENGTH=10000
COMMENT_MAX_DEPTH=3
COMMENT_CACHE_TTL=300
COMMENT_PAGE_SIZE=20
COMMENT_MAX_PAGE_SIZE=100
```

### 9.3 监控指标

- 评论创建成功率
- 评论查询响应时间
- 评论点赞操作频率
- 评论删除操作频率
- 数据库查询性能
- 缓存命中率

## 10. 后续优化方向

### 10.1 功能扩展

- 评论举报功能
- 评论审核机制
- 评论表情回应
- 评论@用户功能
- 评论图片上传

### 10.2 性能优化

- 评论数据分表
- 评论内容全文搜索
- 评论热度算法
- 评论推荐系统
- 实时评论推送

### 10.3 安全加固

- 评论频率限制
- 垃圾评论检测
- 敏感词过滤升级
- 用户行为分析
- 恶意用户封禁